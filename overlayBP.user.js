// ==UserScript==
// @name         Ayaya BP Overlay
// @namespace    http://tampermonkey.net/
// @version      8
// @description  Donnes des stats sur joueur de la partie
// @author       Ayaya
// @match        https://jklm.fun/*
// @match        https://*.jklm.fun/games/bombparty/
// @match        https://jklm.macadelic.me/*
// @match        https://*.jklm.macadelic.me/games/bombparty/
// @match        http://jklm.macadelic.me/*
// @match        http://*.jklm.macadelic.me/games/bombparty/
// @icon         https://www.google.com/s2/favicons?sz=64&domain=jklm.fun
// @grant        none
// ==/UserScript==

let e,t=[],r=null,n=!1,s=!1,o=n;class i{constructor(e=null,t=null,r=null,n=null){this.peerId=e,this.nickname=t,this.language=r,this.roles=n,this.bonusLetters=[],this.word="",this.birthday=!1,this.isReactionTime=!1,this.reactionsTimes=[],this.startReactionTime=0,this.endReactionTime=0,this.wpmWords=[],this.wpmTimes=[],this.wpms=[],this.startWpmTime=0,this.endWpmTime=0,this.isErased=!1,this.numberOfErrorTyped=0,this.errorsPercentage=[],this.lastWpmAverage=null,this.lastReactionTimeAverage=null,this.lastErrorPercentage=null,this.totalCorrectWord=0}updateGeneralInfo(e){this.auth(e[2].auth),this.language(e[2].language),this.nickname(e[2].nickname),this.peerId(e[2].peerId),this.roles(e[2].roles)}updateGameInfo(){this.reactionsTimes=[],this.wpmTimes=[],this.wpmWords=[],this.wpms=[],this.isReactionTime=!0,this.startReactionTime=performance.now(),this.isErased=!1,this.numberOfErrorTyped=0,this.word="",this.errorsPercentage=[],this.wasWordValidated=null}getReactionTimeAverage(){let e=parseFloat(0);for(const t of this.reactionsTimes)e=parseFloat(e)+parseFloat(t);return(e/this.reactionsTimes.length).toFixed(0)}getWpmAverage(){let e=parseFloat(0),t=0;for(const t of this.wpmTimes)e=parseFloat(e)+parseFloat(t);for(const e of this.wpmWords)t+=e;return(6e4*t/e).toFixed(0)}getPrecisionAverage(){let e=parseFloat(0);for(const t of this.errorsPercentage)e=parseFloat(e)+parseFloat(t);return(e/this.errorsPercentage.length*100).toFixed(2)}updateBirthday(){this.birthday=!this.birthday,this.birthday?this.nickname="ðŸŽ‚ "+this.nickname:this.nickname=this.nickname.replace("ðŸŽ‚ ","")}}function a(e){return t.find((t=>t.peerId===e))||null}function l(e){const r=Object.keys(e);t=t.filter((e=>r.includes(e.peerId.toString()))),t=function(e){const t=new Set;return e.filter((e=>!t.has(e.peerId)&&(t.add(e.peerId),!0)))}(t)}function d(){if(e){if(!s)return;e.querySelectorAll("table").forEach((e=>e.remove()));const o=document.createElement("table");o.style.borderSpacing="12px";const i=e=>{const t=document.createElement("th");return t.textContent=e,t.style.fontSize="13px",t.style.fontWeight="bold",t.style.textAlign="left",t.style.color="white",t},a=["Player","Wpm","Reaction","Accuracy"],l=document.createElement("tr");if(a.forEach((e=>l.appendChild(i(e)))),o.appendChild(l),t.forEach((e=>{const t=document.createElement("tr"),s=(e,t)=>{const r=document.createElement("td");return r.textContent=e,r.style.fontSize="12px",r.style.textAlign="left",r.style.color=t||"gray",r};t.appendChild(s(e.nickname,e===r&&n?"lightgray":"gray")),t.appendChild(s(e.getWpmAverage())),t.appendChild(s(e.getReactionTimeAverage()+"ms")),t.appendChild(s(e.getPrecisionAverage()+"%")),n&&(t.addEventListener("click",(function(){r=e,d()})),t.style.cursor="pointer"),o.appendChild(t)})),n){const t=document.createElement("table");t.style.paddingLeft="12px",t.style.borderSpacing="0px";const n=["Letters"],s=document.createElement("tr");n.forEach((e=>{const t=i(e);t.setAttribute("colspan","2"),t.style.paddingTop="2px",t.style.paddingBottom="4px",s.appendChild(t)})),t.appendChild(s);const a=Object.keys(r.bonusLetters);for(const e of a){let n=r.bonusLetters[e];if(n>0){const r=document.createElement("tr"),s=e=>{const t=document.createElement("td");return t.textContent=e,t.style.fontSize="14px",t.style.textAlign="left",t.style.color="#999",t};r.appendChild(s(e.toUpperCase(),"#999")),r.appendChild(s(n)),t.appendChild(r)}}e.appendChild(o),e.appendChild(t)}else e.appendChild(o)}else document.querySelector(".pages .game iframe").focus()}document.addEventListener("keydown",(e=>{switch(e.key){case"F2":n=!n,d();break;case"B":case"b":!function(){if(n){const e=t.find((e=>e.birthday&&e!==r));e&&e.updateBirthday(),r.updateBirthday(),d()}}();break;case"ArrowDown":!function(){if(n){let e=t.indexOf(r);e=(e+1+t.length)%t.length,r=t[e],d()}}();break;case"ArrowUp":!function(){if(n){let e=t.indexOf(r);e=(e-1+t.length)%t.length,r=t[e],d()}}();break;case"F8":t.forEach((e=>{e.birthday&&(socket.emit("setWord",e.nickname,!0),e.updateBirthday())})),socket.emit("setWord","",!1),d()}})),window.addEventListener("load",(function(){if(window.top!==window.self){const c=document.querySelector("body > div.main.page > div.middle");e=document.createElement("div"),e.style="position: absolute;top: 20px;left: 25px;",e.id="statsContainer",c.appendChild(e),socket.on("setup",(e=>{for(const r of e.players)t.push(new i(r.profile.peerId,r.profile.nickname,r.profile.language,r.profile.roles));"round"==e.milestone.name&&(s=!0,t.forEach((t=>{t.updateGameInfo();const r=e.milestone.playerStatesByPeerId[t.peerId];r&&r.bonusLetters&&(t.bonusLetters=r.bonusLetters)})),r=t[0],d())})),socket.on("setMilestone",(e=>{"round"==e.name?(s=!0,n=o,l(e.playerStatesByPeerId),t.forEach((t=>{t.updateGameInfo();const r=e.playerStatesByPeerId[t.peerId];r&&r.bonusLetters&&(t.bonusLetters=r.bonusLetters)})),r=t[0],d()):(o=n,n=!1,d(),s=!1)})),socket.on("nextTurn",((e,t,r)=>{let n=a(e);n.isReactionTime=!0,n.startReactionTime=performance.now(),n.isErased=!1,n.numberOfErrorTyped=0,n.word="",d()})),socket.on("addPlayer",(e=>{var r;r=e,t.push(new i(r.profile.peerId,r.profile.nickname,r.profile.language,r.profile.roles))})),socket.on("correctWord",(({playerPeerId:e,bonusLetters:t})=>{let r=a(e);var n=r.word.replace(/[^a-zA-Z-']/gi,"");r.bonusLetters=t,r.isReactionTime=!1,r.endWpmTime=performance.now();let s=(r.endWpmTime-r.startWpmTime).toFixed(3);for(var o=1,i="",l=0;l<n.length;l++)(i+=n.charAt(l)).length%7==0&&o++;if(r.wpmWords.push(o),r.wpmTimes.push(s),0==r.numberOfErrorTyped)r.errorsPercentage.push(1);else{var d=(r.word.length-r.numberOfErrorTyped)/r.word.length;r.errorsPercentage.push(d)}})),socket.on("failWord",((e,t)=>{let r=a(e);switch(r.wasWordValidated=!1,t){case"mustContainSyllable":break;case"alreadyUsed":case"notInDictionary":r.errorsPercentage.push(0)}})),socket.on("livesLost",((e,t)=>{let r=a(e);r.isReactionTime=!1,r.errorsPercentage.push(0)})),socket.on("removePlayer",(e=>{!function(e){const r=t.findIndex((t=>t.peerId===e));-1!==r&&t.splice(r,1)}(e)})),socket.on("setPlayerWord",((e,t,r)=>{let n=a(e);if(r||(t.length>n.word.length?n.isErased&&(n.isErased=!1):t.length<n.word.length&&(n.isErased||(n.isErased=!0,n.numberOfErrorTyped++))),1==t.length&&(n.startWpmTime=performance.now(),1==n.isReactionTime)){n.endReactionTime=performance.now();let e=(n.endReactionTime-n.startReactionTime).toFixed(3);n.reactionsTimes.push(e),n.isReactionTime=!1}n.word=t})),console.log("Overlay d'Ayaya injectÃ©")}}));
