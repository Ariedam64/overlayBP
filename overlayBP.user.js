// ==UserScript==
// @name         Ayaya BP Overlay
// @namespace    http://tampermonkey.net/
// @version      12
// @description  Donnes des stats sur joueur de la partie
// @author       Ayaya
// @match        https://jklm.fun/*
// @match        https://*.jklm.fun/games/bombparty/
// @match        https://jklm.macadelic.me/*
// @match        https://*.jklm.macadelic.me/games/bombparty/
// @match        http://jklm.macadelic.me/*
// @match        http://*.jklm.macadelic.me/games/bombparty/
// @icon         https://www.google.com/s2/favicons?sz=64&domain=jklm.fun
// @grant        none
// ==/UserScript==

let e,t=[],r=null,n=!1,o=!1,s=n,i=null,a=null,l=0;class c{constructor(e=null,t=null,r=null,n=null){this.peerId=e,this.nickname=t,this.language=r,this.roles=n,this.bonusLetters=[],this.word="",this.birthday=!1,this.isReactionTime=!1,this.reactionsTimes=[],this.startReactionTime=0,this.endReactionTime=0,this.wpmWords=[],this.wpmTimes=[],this.wpms=[],this.startWpmTime=0,this.endWpmTime=0,this.isErased=!1,this.numberOfErrorTyped=0,this.errorsPercentage=[],this.lastWpmAverage=null,this.lastReactionTimeAverage=null,this.lastErrorPercentage=null,this.totalCorrectWord=0}updateGeneralInfo(e){this.auth(e[2].auth),this.language(e[2].language),this.nickname(e[2].nickname),this.peerId(e[2].peerId),this.roles(e[2].roles)}updateGameInfo(){this.reactionsTimes=[],this.wpmTimes=[],this.wpmWords=[],this.wpms=[],this.isReactionTime=!0,this.startReactionTime=performance.now(),this.isErased=!1,this.numberOfErrorTyped=0,this.word="",this.errorsPercentage=[],this.wasWordValidated=null}getReactionTimeAverage(){let e=parseFloat(0);for(const t of this.reactionsTimes)e=parseFloat(e)+parseFloat(t);return(e/this.reactionsTimes.length).toFixed(0)}getWpmAverage(){let e=parseFloat(0),t=0;for(const t of this.wpmTimes)e=parseFloat(e)+parseFloat(t);for(const e of this.wpmWords)t+=e;return(6e4*t/e).toFixed(0)}getPrecisionAverage(){let e=parseFloat(0);for(const t of this.errorsPercentage)e=parseFloat(e)+parseFloat(t);return(e/this.errorsPercentage.length*100).toFixed(2)}updateBirthday(){this.birthday=!this.birthday,this.birthday?this.nickname="ðŸŽ‚ "+this.nickname:this.nickname=this.nickname.replace("ðŸŽ‚ ","")}}function d(e){return t.find((t=>t.peerId===e))||null}function p(e){const r=Object.keys(e);t=t.filter((e=>r.includes(e.peerId.toString()))),t=function(e){const t=new Set;return e.filter((e=>!t.has(e.peerId)&&(t.add(e.peerId),!0)))}(t)}function m(){if(e){if(!o)return;e.querySelectorAll("table").forEach((e=>e.remove()));const s=document.createElement("table");s.style.borderSpacing="12px";const i=e=>{const t=document.createElement("th");return t.textContent=e,t.style.fontSize="13px",t.style.fontWeight="bold",t.style.textAlign="left",t.style.color="white",t},a=["Player","Wpm","Reaction","Accuracy"],l=document.createElement("tr");if(a.forEach((e=>l.appendChild(i(e)))),s.appendChild(l),t.forEach((e=>{const t=document.createElement("tr"),o=(e,t)=>{const r=document.createElement("td");return r.textContent=e,r.style.fontSize="12px",r.style.textAlign="left",r.style.color=t||"gray",r};t.appendChild(o(e.nickname,e===r&&n?"lightgray":"gray")),t.appendChild(o(e.getWpmAverage())),t.appendChild(o(e.getReactionTimeAverage()+"ms")),t.appendChild(o(e.getPrecisionAverage()+"%")),n&&(t.addEventListener("click",(function(){r=e,m()})),t.style.cursor="pointer"),s.appendChild(t)})),n){const t=document.createElement("table");t.style.paddingLeft="12px",t.style.borderSpacing="0px";const n=["Letters"],o=document.createElement("tr");n.forEach((e=>{const t=i(e);t.setAttribute("colspan","2"),t.style.paddingTop="2px",t.style.paddingBottom="4px",o.appendChild(t)})),t.appendChild(o);const a=Object.keys(r.bonusLetters);for(const e of a){let n=r.bonusLetters[e];if(n>0){const r=document.createElement("tr"),o=e=>{const t=document.createElement("td");return t.textContent=e,t.style.fontSize="14px",t.style.textAlign="left",t.style.color="#999",t};r.appendChild(o(e.toUpperCase(),"#999")),r.appendChild(o(n)),t.appendChild(r)}}e.appendChild(s),e.appendChild(t)}else e.appendChild(s)}else document.querySelector(".pages .game iframe").focus()}document.addEventListener("keydown",(s=>{switch(s.key){case"ArrowLeft":e||(document.querySelector(".pages .game iframe").focus(),o=!0),o&&(n=!n,console.log("Emilix"),m());break;case"ArrowRight":!function(){if(n&&0==l){const e=t.find((e=>e.birthday&&e!==r));e&&e.updateBirthday(),r.updateBirthday(),m()}}();break;case"ArrowDown":!function(){if(n){let e=t.indexOf(r);e=(e+1+t.length)%t.length,r=t[e],m()}}();break;case"ArrowUp":!function(){if(n){let e=t.indexOf(r);e=(e-1+t.length)%t.length,r=t[e],m()}}();break;case"F2":a==i&&0==l&&(t.forEach((e=>{e.birthday&&(socket.emit("setWord",e.nickname,!0),e.updateBirthday())})),socket.emit("setWord","",!1),l++,m())}})),window.addEventListener("load",(function(){if(window.top==window.self){const e=socket.constructor.prototype.emit;socket.constructor.prototype.emit=function(...t){if("getChatterProfile"===t[0]){const e=t[t.length-1];t[t.length-1]=t=>{e(t);const r=document.querySelector(".userProfile.pane");if(r){const e=r.querySelector(".language");e&&e.remove();const n=r.querySelector(".nickname").parentNode,o=document.createElement("div");o.className="language",o.textContent=t.language,n.insertBefore(o,n.querySelector(".auth"))}}}return e.apply(socket,t)}}else if(window.top!==window.self){const l=document.querySelector("body > div.main.page > div.middle");e=document.createElement("div"),e.style="position: absolute;top: 20px;left: 25px;",e.id="statsContainer",l.appendChild(e),socket.on("setup",(e=>{for(const r of e.players)t.push(new c(r.profile.peerId,r.profile.nickname,r.profile.language,r.profile.roles));"round"==e.milestone.name?(o=!0,a=e.milestone.currentPlayerPeerId,i=e.selfPeerId,t.forEach((t=>{t.updateGameInfo();const r=e.milestone.playerStatesByPeerId[t.peerId];r&&r.bonusLetters&&(t.bonusLetters=r.bonusLetters)})),r=t[0],m()):i=e.selfPeerId})),socket.on("setMilestone",(e=>{"round"==e.name?(o=!0,n=s,p(e.playerStatesByPeerId),a=e.currentPlayerPeerId,t.forEach((t=>{t.updateGameInfo();const r=e.playerStatesByPeerId[t.peerId];r&&r.bonusLetters&&(t.bonusLetters=r.bonusLetters)})),r=t[0],m()):(s=n,n=!1,m(),o=!1)})),socket.on("nextTurn",((e,t,r)=>{a=e;let n=d(e);n.isReactionTime=!0,n.startReactionTime=performance.now(),n.isErased=!1,n.numberOfErrorTyped=0,n.word="",m()})),socket.on("addPlayer",(e=>{var r;r=e,t.push(new c(r.profile.peerId,r.profile.nickname,r.profile.language,r.profile.roles))})),socket.on("correctWord",(({playerPeerId:e,bonusLetters:t})=>{let r=d(e);var n=r.word.replace(/[^a-zA-Z-']/gi,"");r.bonusLetters=t,r.isReactionTime=!1,r.endWpmTime=performance.now();let o=(r.endWpmTime-r.startWpmTime).toFixed(3);for(var s=1,i="",a=0;a<n.length;a++)(i+=n.charAt(a)).length%7==0&&s++;if(r.wpmWords.push(s),r.wpmTimes.push(o),0==r.numberOfErrorTyped)r.errorsPercentage.push(1);else{var l=(r.word.length-r.numberOfErrorTyped)/r.word.length;r.errorsPercentage.push(l)}})),socket.on("failWord",((e,t)=>{let r=d(e);switch(r.wasWordValidated=!1,t){case"mustContainSyllable":break;case"alreadyUsed":case"notInDictionary":r.errorsPercentage.push(0)}})),socket.on("livesLost",((e,t)=>{let r=d(e);r.isReactionTime=!1,r.errorsPercentage.push(0)})),socket.on("removePlayer",(e=>{!function(e){const r=t.findIndex((t=>t.peerId===e));-1!==r&&t.splice(r,1)}(e)})),socket.on("setPlayerWord",((e,t,r)=>{let n=d(e);if(r||(t.length>n.word.length?n.isErased&&(n.isErased=!1):t.length<n.word.length&&(n.isErased||(n.isErased=!0,n.numberOfErrorTyped++))),1==t.length&&(n.startWpmTime=performance.now(),1==n.isReactionTime)){n.endReactionTime=performance.now();let e=(n.endReactionTime-n.startReactionTime).toFixed(3);n.reactionsTimes.push(e),n.isReactionTime=!1}n.word=t})),console.log("Overlay d'Ayaya injectÃ©")}}));
