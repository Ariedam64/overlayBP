// ==UserScript==
// @name         Ayaya BP Overlay
// @namespace    http://tampermonkey.net/
// @version      5
// @description  Donnes des stats sur joueur de la partie
// @author       Ayaya
// @match        https://jklm.fun/*
// @match        https://*.jklm.fun/games/bombparty/
// @match        https://jklm.macadelic.me/*
// @match        https://*.jklm.macadelic.me/games/bombparty/
// @match        http://jklm.macadelic.me/*
// @match        http://*.jklm.macadelic.me/games/bombparty/
// @icon         https://www.google.com/s2/favicons?sz=64&domain=jklm.fun
// @grant        none
// ==/UserScript==

let e,t=[],n=null,r=!0;class o{constructor(e=null,t=null,n=null,r=null){this.peerId=e,this.nickname=t,this.language=n,this.roles=r,this.bonusLetters=[],this.word="",this.isReactionTime=!1,this.reactionsTimes=[],this.startReactionTime=0,this.endReactionTime=0,this.wpmWords=[],this.wpmTimes=[],this.wpms=[],this.startWpmTime=0,this.endWpmTime=0,this.isErased=!1,this.numberOfErrorTyped=0,this.errorsPercentage=[],this.lastWpmAverage=null,this.lastReactionTimeAverage=null,this.lastErrorPercentage=null,this.totalCorrectWord=0}updateGeneralInfo(e){this.auth(e[2].auth),this.language(e[2].language),this.nickname(e[2].nickname),this.peerId(e[2].peerId),this.roles(e[2].roles)}updateGameInfo(){this.reactionsTimes=[],this.wpmTimes=[],this.wpmWords=[],this.wpms=[],this.isReactionTime=!0,this.startReactionTime=performance.now(),this.isErased=!1,this.numberOfErrorTyped=0,this.word="",this.errorsPercentage=[],this.wasWordValidated=null}getReactionTimeAverage(){let e=parseFloat(0);for(const t of this.reactionsTimes)e=parseFloat(e)+parseFloat(t);return(e/this.reactionsTimes.length).toFixed(0)}getWpmAverage(){let e=parseFloat(0),t=0;for(const t of this.wpmTimes)e=parseFloat(e)+parseFloat(t);for(const e of this.wpmWords)t+=e;return(6e4*t/e).toFixed(0)}getPrecisionAverage(){let e=parseFloat(0);for(const t of this.errorsPercentage)e=parseFloat(e)+parseFloat(t);return(e/this.errorsPercentage.length*100).toFixed(2)}}function s(e){return t.find((t=>t.peerId===e))||null}function i(e){const n=Object.keys(e);t=t.filter((e=>n.includes(e.peerId.toString()))),t=function(e){const t=new Set;return e.filter((e=>!t.has(e.peerId)&&(t.add(e.peerId),!0)))}(t)}function a(){const o=e.querySelectorAll("table");o&&o.forEach((e=>{e.remove()}));const s=document.createElement("table");s.style.borderSpacing="12px";const i=document.createElement("tr");if(["Player","Wpm","Reaction","Accuracy"].forEach((e=>{const t=document.createElement("th");t.textContent=e,t.style.fontSize="13px",t.style.fontWeight="bold",t.style.textAlign="left",t.style.color="white",i.appendChild(t)})),s.appendChild(i),t.forEach((e=>{const t=document.createElement("tr"),o=t=>{const o=document.createElement("td");return o.textContent=t,o.style.fontSize="12px",o.style.textAlign="left",o.style.color=e===n&&r?"lightgray":"gray",o};t.appendChild(o(e.nickname)),t.appendChild(o(e.getWpmAverage())),t.appendChild(o(e.getReactionTimeAverage()+"ms")),t.appendChild(o(e.getPrecisionAverage()+"%")),s.appendChild(t)})),r){const r=s.getElementsByTagName("tr");for(let e=0;e<r.length;e++)r[e].addEventListener("click",(function(){n=t[e-1],a()})),r[e].style.cursor="pointer";const o=document.createElement("table");o.style.paddingLeft="12px",o.style.borderSpacing="0px";const i=document.createElement("tr");["Letters"].forEach((e=>{const t=document.createElement("th");t.textContent=e,t.style.fontSize="13px",t.style.fontWeight="bold",t.setAttribute("colspan","2"),t.style.textAlign="left",t.style.color="white",t.style.paddingTop="2px",t.style.paddingBottom="4px",i.appendChild(t)})),o.appendChild(i);const l=Object.keys(n.bonusLetters);for(const e of l){let t=n.bonusLetters[e];if(t>0){const n=document.createElement("tr"),r=e=>{const t=document.createElement("td");return t.textContent=e,t.style.fontSize="14px",t.style.textAlign="left",t.style.color="#999",t};n.appendChild(r(e.toUpperCase())),n.appendChild(r(t)),o.appendChild(n)}}e.appendChild(s),e.appendChild(o)}else e.appendChild(s)}document.addEventListener("keydown",(e=>{"F2"===e.key&&(r=!r,a())})),window.addEventListener("load",(function(){if(window.top!==window.self){const r=document.querySelector("body > div.main.page > div.middle");e=document.createElement("div"),e.style="position: absolute;top: 20px;left: 25px;",e.id="statsContainer",r.appendChild(e);socket.on("setup",(e=>{for(const n of e.players)t.push(new o(n.profile.peerId,n.profile.nickname,n.profile.language,n.profile.roles));"round"==e.milestone.name&&(t.forEach((t=>{t.updateGameInfo();const n=e.milestone.playerStatesByPeerId[t.peerId];n&&n.bonusLetters&&(t.bonusLetters=n.bonusLetters)})),n=t[0],a())})),socket.on("setMilestone",(e=>{"round"==e.name&&(i(e.playerStatesByPeerId),t.forEach((t=>{t.updateGameInfo();const n=e.playerStatesByPeerId[t.peerId];n&&n.bonusLetters&&(t.bonusLetters=n.bonusLetters)})),n=t[0],a())})),socket.on("nextTurn",((e,t,n)=>{let r=s(e);r.isReactionTime=!0,r.startReactionTime=performance.now(),r.isErased=!1,r.numberOfErrorTyped=0,r.word="",a()})),socket.on("addPlayer",(e=>{var n;n=e,t.push(new o(n.profile.peerId,n.profile.nickname,n.profile.language,n.profile.roles))})),socket.on("correctWord",(({playerPeerId:e,bonusLetters:t})=>{let n=s(e);var r=n.word.replace(/[^a-zA-Z-']/gi,"");n.bonusLetters=t,n.isReactionTime=!1,n.endWpmTime=performance.now();let o=(n.endWpmTime-n.startWpmTime).toFixed(3);for(var i=1,a="",l=0;l<r.length;l++)(a+=r.charAt(l)).length%7==0&&i++;if(n.wpmWords.push(i),n.wpmTimes.push(o),0==n.numberOfErrorTyped)n.errorsPercentage.push(1);else{var d=(n.word.length-n.numberOfErrorTyped)/n.word.length;n.errorsPercentage.push(d)}})),socket.on("failWord",((e,t)=>{let n=s(e);switch(n.wasWordValidated=!1,t){case"mustContainSyllable":break;case"alreadyUsed":case"notInDictionary":n.errorsPercentage.push(0)}})),socket.on("livesLost",((e,t)=>{let n=s(e);n.isReactionTime=!1,n.errorsPercentage.push(0)})),socket.on("removePlayer",(e=>{!function(e){const n=t.findIndex((t=>t.peerId===e));-1!==n&&t.splice(n,1)}(e)})),socket.on("setPlayerWord",((e,t,n)=>{let r=s(e);if(n||(t.length>r.word.length?r.isErased&&(r.isErased=!1):t.length<r.word.length&&(r.isErased||(r.isErased=!0,r.numberOfErrorTyped++))),1==t.length&&(r.startWpmTime=performance.now(),1==r.isReactionTime)){r.endReactionTime=performance.now();let e=(r.endReactionTime-r.startReactionTime).toFixed(3);r.reactionsTimes.push(e),r.isReactionTime=!1}r.word=t})),console.log("Overlay d'Ayaya injectÃ©")}}));
