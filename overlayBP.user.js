// ==UserScript==
// @name         Ayaya BP Overlay
// @namespace    http://tampermonkey.net/
// @version      3
// @description  Donnes des stats sur joueur de la partie
// @author       Ayaya
// @match        https://jklm.fun/*
// @match        https://*.jklm.fun/games/bombparty/
// @match        https://jklm.macadelic.me/*
// @match        https://*.jklm.macadelic.me/games/bombparty/
// @match        http://jklm.macadelic.me/*
// @match        http://*.jklm.macadelic.me/games/bombparty/
// @icon         https://www.google.com/s2/favicons?sz=64&domain=jklm.fun
// @grant        none
// ==/UserScript==

let statsContainer,playersList=[],selectedPlayer=null,isShowBL=!0;class Player{constructor(e=null,t=null,r=null,s=null){this.peerId=e,this.nickname=t,this.language=r,this.roles=s,this.bonusLetters=[],this.word="",this.isReactionTime=!1,this.reactionsTimes=[],this.startReactionTime=0,this.endReactionTime=0,this.wpmWords=[],this.wpmTimes=[],this.wpms=[],this.startWpmTime=0,this.endWpmTime=0,this.isErased=!1,this.numberOfErrorTyped=0,this.errorsPercentage=[],this.lastWpmAverage=null,this.lastReactionTimeAverage=null,this.lastErrorPercentage=null,this.totalCorrectWord=0}updateGeneralInfo(e){this.auth(e[2].auth),this.language(e[2].language),this.nickname(e[2].nickname),this.peerId(e[2].peerId),this.roles(e[2].roles)}updateGameInfo(){this.reactionsTimes=[],this.wpmTimes=[],this.wpmWords=[],this.wpms=[],this.isReactionTime=!0,this.startReactionTime=performance.now(),this.isErased=!1,this.numberOfErrorTyped=0,this.word="",this.errorsPercentage=[],this.wasWordValidated=null}getReactionTimeAverage(){let e=parseFloat(0);for(const t of this.reactionsTimes)e=parseFloat(e)+parseFloat(t);return(e/this.reactionsTimes.length).toFixed(0)}getWpmAverage(){let e=parseFloat(0),t=0;for(const t of this.wpmTimes)e=parseFloat(e)+parseFloat(t);for(const e of this.wpmWords)t+=e;return(6e4*t/e).toFixed(0)}getPrecisionAverage(){let e=parseFloat(0);for(const t of this.errorsPercentage)e=parseFloat(e)+parseFloat(t);return(e/this.errorsPercentage.length*100).toFixed(2)}}function addPlayer(e){playersList.push(new Player(e.profile.peerId,e.profile.nickname,e.profile.language,e.profile.roles))}function findPlayerByPeerId(e){return playersList.find((t=>t.peerId===e))||null}function removeDuplicatesByPeerId(e){const t=new Set;return e.filter((e=>!t.has(e.peerId)&&(t.add(e.peerId),!0)))}function removePlayer(e){const t=playersList.findIndex((t=>t.peerId===e));-1!==t&&playersList.splice(t,1)}function updatePlayerList(e){const t=Object.keys(e);playersList=playersList.filter((e=>t.includes(e.peerId.toString()))),playersList=removeDuplicatesByPeerId(playersList)}function createOverlay(){const e=statsContainer.querySelectorAll("table");e&&e.forEach((e=>{e.remove()}));const t=document.createElement("table");t.style.borderSpacing="12px";const r=document.createElement("tr");if(["Player","Wpm","Reaction","Accuracy"].forEach((e=>{const t=document.createElement("th");t.textContent=e,t.style.fontSize="13px",t.style.fontWeight="bold",t.style.textAlign="left",t.style.color="white",r.appendChild(t)})),t.appendChild(r),playersList.forEach((e=>{const r=document.createElement("tr"),s=t=>{const r=document.createElement("td");return r.textContent=t,r.style.fontSize="12px",r.style.textAlign="left",r.style.color=e===selectedPlayer&&isShowBL?"lightgray":"gray",r};r.appendChild(s(e.nickname)),r.appendChild(s(e.getWpmAverage())),r.appendChild(s(e.getReactionTimeAverage()+"ms")),r.appendChild(s(e.getPrecisionAverage()+"%")),t.appendChild(r)})),isShowBL){const e=t.getElementsByTagName("tr");for(let t=0;t<e.length;t++)e[t].addEventListener("click",(function(){selectedPlayer=playersList[t-1],createOverlay(statsContainer)})),e[t].style.cursor="pointer";const r=document.createElement("table");r.style.paddingLeft="12px",r.style.borderSpacing="0px";const s=document.createElement("tr");["Letters"].forEach((e=>{const t=document.createElement("th");t.textContent=e,t.style.fontSize="13px",t.style.fontWeight="bold",t.setAttribute("colspan","2"),t.style.textAlign="left",t.style.color="white",t.style.paddingTop="2px",t.style.paddingBottom="4px",s.appendChild(t)})),r.appendChild(s);const n=Object.keys(selectedPlayer.bonusLetters);for(const e of n){let t=selectedPlayer.bonusLetters[e];if(t>0){const s=document.createElement("tr"),n=e=>{const t=document.createElement("td");return t.textContent=e,t.style.fontSize="14px",t.style.textAlign="left",t.style.color="#999",t};s.appendChild(n(e.toUpperCase())),s.appendChild(n(t)),r.appendChild(s)}}statsContainer.appendChild(t),statsContainer.appendChild(r)}else statsContainer.appendChild(t)}document.addEventListener("keydown",(e=>{"F2"===e.key&&(isShowBL=!isShowBL,createOverlay(statsContainer))})),window.addEventListener("load",(function(){if(window.top!==window.self){const e=document.querySelector("body > div.main.page > div.middle");statsContainer=document.createElement("div"),statsContainer.style="position: absolute;top: 20px;left: 25px;",statsContainer.id="statsContainer",e.appendChild(statsContainer);socket.on("setup",(e=>{for(const t of e.players)playersList.push(new Player(t.profile.peerId,t.profile.nickname,t.profile.language,t.profile.roles));"round"==e.milestone.name&&(playersList.forEach((t=>{t.updateGameInfo();const r=e.milestone.playerStatesByPeerId[t.peerId];r&&r.bonusLetters&&(t.bonusLetters=r.bonusLetters)})),selectedPlayer=playersList[0],createOverlay())})),socket.on("setMilestone",(e=>{"round"==e.name&&(updatePlayerList(e.playerStatesByPeerId),playersList.forEach((t=>{t.updateGameInfo();const r=e.playerStatesByPeerId[t.peerId];r&&r.bonusLetters&&(t.bonusLetters=r.bonusLetters)})),selectedPlayer=playersList[0],createOverlay())})),socket.on("nextTurn",((e,t,r)=>{let s=findPlayerByPeerId(e);s.isReactionTime=!0,s.startReactionTime=performance.now(),s.isErased=!1,s.numberOfErrorTyped=0,s.word="",createOverlay()})),socket.on("addPlayer",(e=>{addPlayer(e)})),socket.on("correctWord",(({playerPeerId:e,bonusLetters:t})=>{let r=findPlayerByPeerId(e);var s=r.word.replace(/[^a-zA-Z-']/gi,"");r.bonusLetters=t,r.isReactionTime=!1,r.endWpmTime=performance.now();let n=(r.endWpmTime-r.startWpmTime).toFixed(3);for(var a=1,o="",i=0;i<s.length;i++)(o+=s.charAt(i)).length%7==0&&a++;if(r.wpmWords.push(a),r.wpmTimes.push(n),0==r.numberOfErrorTyped)r.errorsPercentage.push(1);else{var l=(r.word.length-r.numberOfErrorTyped)/r.word.length;r.errorsPercentage.push(l)}})),socket.on("failWord",((e,t)=>{let r=findPlayerByPeerId(e);switch(r.wasWordValidated=!1,t){case"mustContainSyllable":break;case"alreadyUsed":case"notInDictionary":r.errorsPercentage.push(0)}})),socket.on("livesLost",((e,t)=>{let r=findPlayerByPeerId(e);r.isReactionTime=!1,r.errorsPercentage.push(0)})),socket.on("removePlayer",(e=>{removePlayer(e)})),socket.on("setPlayerWord",((e,t,r)=>{let s=findPlayerByPeerId(e);if(r||(t.length>s.word.length?s.isErased&&(s.isErased=!1):t.length<s.word.length&&(s.isErased||(s.isErased=!0,s.numberOfErrorTyped++))),1==t.length&&(s.startWpmTime=performance.now(),1==s.isReactionTime)){s.endReactionTime=performance.now();let e=(s.endReactionTime-s.startReactionTime).toFixed(3);s.reactionsTimes.push(e),s.isReactionTime=!1}s.word=t})),console.log("Overlay d'Ayaya injectÃ©")}}));
